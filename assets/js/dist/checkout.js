!function(){"use strict";const e=window.fpExpTranslate&&window.fpExpTranslate.localize?window.fpExpTranslate.localize:e=>e;function t(t,n){if(!t)return;if(t.innerHTML="",!n.length)return void(t.hidden=!0);const o=document.createElement("p");o.className="fp-exp-error-summary__intro",o.textContent=t.getAttribute("data-intro")||e("Controlla i campi evidenziati."),t.appendChild(o);const a=document.createElement("ul");a.className="fp-exp-error-summary__list",n.forEach(e=>{const n=document.createElement("li");if(e.id){const o=document.createElement("a");o.href=`#${e.id}`,o.textContent=e.message,o.addEventListener("click",n=>{n.preventDefault();const o=t.ownerDocument.getElementById(e.id);o&&"function"==typeof o.focus&&o.focus()}),n.appendChild(o)}else n.textContent=e.message;a.appendChild(n)}),t.appendChild(a),t.hidden=!1,t.focus()}function n(e){e&&(e.hidden=!0,e.innerHTML="")}function o(e){e&&(e.setAttribute("aria-invalid","true"),e.classList.add("is-invalid"))}var a;a=function(){document.querySelectorAll('[data-fp-shortcode="checkout"] form.fp-exp-checkout__form').forEach(a=>{const i=a.querySelector("[data-fp-error-summary]"),r=a.closest('[data-fp-shortcode="checkout"]');a.querySelectorAll("input, select, textarea").forEach(e=>{const t="checkbox"===e.type?"change":"input";e.addEventListener(t,()=>{!function(e){e&&(e.removeAttribute("aria-invalid"),e.classList.remove("is-invalid"))}(e)})}),a.addEventListener("submit",r=>{r.preventDefault(),n(i);const c=function(t){const n=[];if(!t)return n;const a=t.getAttribute("data-error-required")||e("Completa il campo %s."),i=t.getAttribute("data-error-email")||"Enter a valid email address.";Array.from(t.querySelectorAll("[required]")).forEach(e=>{if(!(e instanceof HTMLInputElement&&"checkbox"===e.type?e.checked:(e.value||"").trim())){o(e);const i=function(e,t){if(!t||!e)return"field";if(t.id){const n=e.querySelector(`label[for="${t.id}"]`);if(n&&n.textContent)return n.textContent.replace(/[*:]/g,"").trim()||t.name||"field"}return t.name||"field"}(t,e);n.push({id:e.id,message:a.replace("%s",i)})}});const r=t.querySelector('input[type="email"]');if(r){const e=(r.value||"").trim();e&&!function(e){return!!e&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}(e)&&(o(r),n.push({id:r.id,message:i}))}return n}(a);if(c.length)return void t(i,c);const s=new FormData(a),d=Object.fromEntries(s.entries());a.dispatchEvent(new CustomEvent("fpExpCheckoutSubmit",{bubbles:!0,detail:{payload:d,nonce:a.getAttribute("data-nonce")}}))}),a.addEventListener("fpExpCheckoutSubmit",async o=>{const r=o&&o.detail?o.detail:{},c=a.querySelector(".fp-exp-checkout__submit"),s=e=>{c&&(c.disabled=Boolean(e),e?c.setAttribute("aria-busy","true"):c.removeAttribute("aria-busy"))},d=n=>{const o=[{message:n||(e?e("Impossibile generare l’ordine di pagamento. Riprova."):"Impossibile generare l’ordine di pagamento. Riprova.")}];t(i,o)};try{n(i),s(!0);const e="undefined"!=typeof window&&window.fpExpConfig?window.fpExpConfig:{},t=(e.restUrl||"").replace(/\/?$/,"/"),o=e.ajaxUrl||"",a=r.payload||{},c={nonce:r.nonce||"",contact:a.contact||{},billing:a.billing||{},consent:a.consent||{}};let l="";if(t)try{const n={"Content-Type":"application/json"};e.restNonce&&(n["X-WP-Nonce"]=e.restNonce);const o=await fetch(t+"checkout",{method:"POST",headers:n,credentials:"same-origin",body:JSON.stringify(c)}),a=await o.json().catch(()=>({}));o.ok&&a&&a.payment_url?l=String(a.payment_url):401===o.status||403===o.status||!o.ok&&a&&a.message&&d(String(a.message))}catch(e){}if(!l&&o)try{const e=new FormData;e.set("action","fp_exp_checkout"),e.set("nonce",c.nonce),e.set("contact",JSON.stringify(c.contact)),e.set("billing",JSON.stringify(c.billing)),e.set("consent",JSON.stringify(c.consent));const t=await fetch(o,{method:"POST",credentials:"same-origin",body:e}),n=await t.json().catch(()=>({}));n&&n.success&&n.data&&n.data.payment_url?l=String(n.data.payment_url):n&&n.data&&n.data.message&&d(String(n.data.message))}catch(e){}if(l)return void window.location.assign(l);d()}finally{s(!1)}},{once:!1});const c=r&&r.querySelector(".fp-exp-checkout__unlock");c&&c.addEventListener("click",async()=>{const e="undefined"!=typeof window&&window.fpExpConfig?window.fpExpConfig:{},t=(e.restUrl||"").replace(/\/?$/,"/");try{if(t){const n={"Content-Type":"application/json"};if(e.restNonce&&(n["X-WP-Nonce"]=e.restNonce),!(await fetch(t+"cart/unlock",{method:"POST",headers:n,credentials:"same-origin"})).ok)throw new Error("rest_unlock_failed")}}catch(t){try{const t=new FormData;t.set("action","fp_exp_unlock_cart"),t.set("nonce",e.checkoutNonce||""),await fetch(e.ajaxUrl,{method:"POST",credentials:"same-origin",body:t})}catch(e){document.cookie="fp_exp_sid=; Max-Age=0; path=/"}}location.reload()})})},"complete"===document.readyState||"interactive"===document.readyState?a():document.addEventListener("DOMContentLoaded",a,{once:!0})}();