!function(){"use strict";const e=window.fpExpTranslate&&window.fpExpTranslate.localize?window.fpExpTranslate.localize:e=>e;function t(t,n){if(!t)return;if(t.innerHTML="",!n.length)return void(t.hidden=!0);const o=document.createElement("p");o.className="fp-exp-error-summary__intro",o.textContent=t.getAttribute("data-intro")||e("Controlla i campi evidenziati."),t.appendChild(o);const a=document.createElement("ul");a.className="fp-exp-error-summary__list",n.forEach(e=>{const n=document.createElement("li");if(e.id){const o=document.createElement("a");o.href=`#${e.id}`,o.textContent=e.message,o.addEventListener("click",n=>{n.preventDefault();const o=t.ownerDocument.getElementById(e.id);o&&"function"==typeof o.focus&&o.focus()}),n.appendChild(o)}else n.textContent=e.message;a.appendChild(n)}),t.appendChild(a),t.hidden=!1,t.focus()}function n(e){e&&(e.hidden=!0,e.innerHTML="")}function o(e){e&&(e.setAttribute("aria-invalid","true"),e.classList.add("is-invalid"))}var a;a=function(){document.querySelectorAll('[data-fp-shortcode="checkout"] form.fp-exp-checkout__form').forEach(a=>{const i=a.querySelector("[data-fp-error-summary]"),c=a.closest('[data-fp-shortcode="checkout"]');a.querySelectorAll("input, select, textarea").forEach(e=>{const t="checkbox"===e.type?"change":"input";e.addEventListener(t,()=>{!function(e){e&&(e.removeAttribute("aria-invalid"),e.classList.remove("is-invalid"))}(e)})}),a.addEventListener("submit",async c=>{c.preventDefault(),n(i);const r=function(t){const n=[];if(!t)return n;const a=t.getAttribute("data-error-required")||e("Completa il campo %s."),i=t.getAttribute("data-error-email")||"Enter a valid email address.";Array.from(t.querySelectorAll("[required]")).forEach(e=>{if(!(e instanceof HTMLInputElement&&"checkbox"===e.type?e.checked:(e.value||"").trim())){o(e);const i=function(e,t){if(!t||!e)return"field";if(t.id){const n=e.querySelector(`label[for="${t.id}"]`);if(n&&n.textContent)return n.textContent.replace(/[*:]/g,"").trim()||t.name||"field"}return t.name||"field"}(t,e);n.push({id:e.id,message:a.replace("%s",i)})}});const c=t.querySelector('input[type="email"]');if(c){const e=(c.value||"").trim();e&&!function(e){return!!e&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}(e)&&(o(c),n.push({id:c.id,message:i}))}return n}(a);if(r.length)return void t(i,r);const s=new FormData(a),d=Object.fromEntries(s.entries());let l=a.getAttribute("data-nonce")||"";const u="undefined"!=typeof window&&window.fpExpConfig?window.fpExpConfig:{},p=(u.restUrl||"").replace(/\/?$/,"/"),f=u.ajaxUrl||"";if(p)try{const e={};u.restNonce&&(e["X-WP-Nonce"]=u.restNonce);const t=await fetch(p+"checkout/nonce",{method:"GET",headers:e,credentials:"same-origin"});if(t.ok){const e=await t.json();e&&e.nonce&&(l=e.nonce)}}catch(e){}if(!l&&f)try{const e=new FormData;e.set("action","fp_exp_get_nonce");const t=await fetch(f,{method:"POST",credentials:"same-origin",body:e}),n=await t.json();n&&n.success&&n.data&&n.data.nonce&&(l=n.data.nonce)}catch(e){}a.dispatchEvent(new CustomEvent("fpExpCheckoutSubmit",{bubbles:!0,detail:{payload:d,nonce:l}}))}),a.addEventListener("fpExpCheckoutSubmit",async o=>{const c=o&&o.detail?o.detail:{},r=a.querySelector(".fp-exp-checkout__submit"),s=e=>{r&&(r.disabled=Boolean(e),e?r.setAttribute("aria-busy","true"):r.removeAttribute("aria-busy"))},d=n=>{const o=[{message:n||(e?e("Impossibile generare l’ordine di pagamento. Riprova."):"Impossibile generare l’ordine di pagamento. Riprova.")}];t(i,o)};try{n(i),s(!0);const e="undefined"!=typeof window&&window.fpExpConfig?window.fpExpConfig:{},t=(e.restUrl||"").replace(/\/?$/,"/"),o=e.ajaxUrl||"",a=c.payload||{},r={nonce:c.nonce||"",contact:a.contact||{},billing:a.billing||{},consent:a.consent||{}};let l="";if(t)try{const n={"Content-Type":"application/json"};e.restNonce&&(n["X-WP-Nonce"]=e.restNonce);const o=await fetch(t+"checkout",{method:"POST",headers:n,credentials:"same-origin",body:JSON.stringify(r)}),a=await o.json().catch(()=>({}));o.ok&&a&&a.payment_url?l=String(a.payment_url):401===o.status||403===o.status||!o.ok&&a&&a.message&&d(String(a.message))}catch(e){}if(!l&&o)try{const e=new FormData;e.set("action","fp_exp_checkout"),e.set("nonce",r.nonce),e.set("contact",JSON.stringify(r.contact)),e.set("billing",JSON.stringify(r.billing)),e.set("consent",JSON.stringify(r.consent));const t=await fetch(o,{method:"POST",credentials:"same-origin",body:e}),n=await t.json().catch(()=>({}));n&&n.success&&n.data&&n.data.payment_url?l=String(n.data.payment_url):n&&n.data&&n.data.message&&d(String(n.data.message))}catch(e){}if(l)return void window.location.assign(l);d()}finally{s(!1)}},{once:!1});const r=c&&c.querySelector(".fp-exp-checkout__unlock");r&&r.addEventListener("click",async()=>{const e="undefined"!=typeof window&&window.fpExpConfig?window.fpExpConfig:{},t=(e.restUrl||"").replace(/\/?$/,"/");try{if(t){const n={"Content-Type":"application/json"};if(e.restNonce&&(n["X-WP-Nonce"]=e.restNonce),!(await fetch(t+"cart/unlock",{method:"POST",headers:n,credentials:"same-origin"})).ok)throw new Error("rest_unlock_failed")}}catch(t){try{const t=new FormData;t.set("action","fp_exp_unlock_cart"),t.set("nonce",e.checkoutNonce||""),await fetch(e.ajaxUrl,{method:"POST",credentials:"same-origin",body:t})}catch(e){document.cookie="fp_exp_sid=; Max-Age=0; path=/"}}location.reload()})})},"complete"===document.readyState||"interactive"===document.readyState?a():document.addEventListener("DOMContentLoaded",a,{once:!0})}();