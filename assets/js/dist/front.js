!function(){"use strict";"undefined"!=typeof jQuery&&jQuery(document).ready(function(e){window.FPFront||(window.FPFront={});const t=document.querySelector(".fp-exp.fp-exp-widget"),n=document.getElementById("fp-exp-date-input"),a=document.querySelector(".fp-exp-slots"),r=document.querySelector(".fp-exp-page__aside"),o=document.querySelector(".fp-exp-section.fp-exp-gallery"),i=()=>{const e=window.innerWidth<1024;if(e&&r&&o)r.classList.contains("is-mobile-inline")||(r.classList.add("is-mobile-inline"),o.nextSibling?o.parentNode.insertBefore(r,o.nextSibling):o.parentNode.appendChild(r));else if(!e&&r&&r.classList.contains("is-mobile-inline")){r.classList.remove("is-mobile-inline");const e=document.querySelector(".fp-grid.fp-exp-page__layout"),t=document.querySelector(".fp-main.fp-exp-page__main");e&&t&&t.nextSibling?e.insertBefore(r,t.nextSibling):e&&t&&e.appendChild(r)}};let s;if(i(),window.addEventListener("resize",()=>{clearTimeout(s),s=setTimeout(i,150)}),!t)return;let c={};try{const e=t.getAttribute("data-config")||"{}";c=JSON.parse(e),window.FPFront.config=c}catch(e){}if(n){const e=()=>{try{"function"==typeof n.showPicker?n.showPicker():n.focus()}catch(e){n.focus()}};n.addEventListener("click",e),n.addEventListener("focus",()=>{e()})}const l=e=>{if(a)if(e){const e=a.getAttribute("data-loading-label")||"Caricamento…";a.innerHTML='<p class="fp-exp-slots__placeholder">'+e+"</p>"}else a.innerHTML=""};window.FPFront.slots&&window.FPFront.slots.init({slotsEl:a});window.FPFront.availability&&window.FPFront.availability.init&&window.FPFront.availability.init({config:c,widget:t});const d=()=>window.FPFront.availability&&window.FPFront.availability.getCalendarMap&&window.FPFront.availability.getCalendarMap()||new Map;let p=d();n&&n.addEventListener("change",async()=>{const e=n.value;p=d();let t=p.get(e)||[],r=!1;if(!t||0===t.length){l(!0),r=!0;try{t=await(async e=>window.FPFront.availability?window.FPFront.availability.fetchAvailability(e):[])(e)}catch(e){return(e=>{if(!a)return;const t=e||"Impossibile caricare gli slot. Riprova.";a.innerHTML='<p class="fp-exp-slots__placeholder">'+t+"</p>"})("Impossibile caricare gli slot. Riprova."),void(t=[])}}if(window.FPFront.slots&&window.FPFront.slots.renderSlots)window.FPFront.slots.renderSlots(t);else if(r)if(l(!1),t&&t.length>0){const e=document.createElement("ul");e.className="fp-exp-slots__list",t.forEach(t=>{const n=document.createElement("li");n.className="fp-exp-slots__item",n.textContent=t.time||t.label||"Slot",n.setAttribute("data-start",t.start||t.start_iso||""),n.setAttribute("data-end",t.end||t.end_iso||""),e.appendChild(n)}),a&&(a.innerHTML="",a.appendChild(e))}else a&&(a.innerHTML='<p class="fp-exp-slots__placeholder">Nessuna fascia disponibile per questa data</p>');else if(t&&t.length>0)if(window.FPFront.slots&&window.FPFront.slots.renderSlots)window.FPFront.slots.renderSlots(t);else{const e=document.createElement("ul");e.className="fp-exp-slots__list",t.forEach(t=>{const n=document.createElement("li");n.className="fp-exp-slots__item",n.textContent=t.time||t.label||"Slot",n.setAttribute("data-start",t.start||t.start_iso||""),n.setAttribute("data-end",t.end||t.end_iso||""),e.appendChild(n)}),a&&(a.innerHTML="",a.appendChild(e))}else a&&(a.innerHTML='<p class="fp-exp-slots__placeholder">Nessuna fascia disponibile per questa data</p>');window.FPFront.availability&&window.FPFront.availability.prefetchMonth&&window.FPFront.availability.monthKeyOf&&window.FPFront.availability.prefetchMonth(window.FPFront.availability.monthKeyOf(e))});const u=async(e,t)=>{const n=t.getFullYear()+"-"+String(t.getMonth()+1).padStart(2,"0"),a=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"][t.getMonth()],r=t.getFullYear(),o=e.querySelector(".fp-exp-calendar-nav__month"),i=e.querySelector(".fp-exp-calendar-nav__year"),s=e.querySelector(".fp-exp-calendar-nav__content");o&&(o.textContent=a),i&&(i.textContent=r),s&&s.setAttribute("data-current-month",n);const c=new Date(t.getFullYear(),t.getMonth()+1,0).getDate(),l=e.querySelector(".fp-exp-calendar-nav__grid");if(l){l.innerHTML='<div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: var(--fp-color-muted);">Caricamento...</div>';try{await(async e=>window.FPFront.availability&&window.FPFront.availability.prefetchMonth(e))(n),p=d();const e=[];for(let t=1;t<=c;t++){const a=n+"-"+String(t).padStart(2,"0"),r=new Date(a)<new Date((new Date).setHours(0,0,0,0)),o=p.get(a),i=o&&o.length||0,s=i>0,c=document.createElement("button");c.type="button",c.className="fp-exp-calendar-nav__day"+(r?" is-past":""),c.setAttribute("data-date",a),c.setAttribute("data-available",s?"1":"0"),c.setAttribute("data-month",n),!r&&s||(c.disabled=!0);let l="";i>0&&(l=`<span class="fp-exp-calendar-nav__day-slots">${i} slot</span>`),c.innerHTML=`\n                            <span class="fp-exp-calendar-nav__day-number">${t}</span>\n                            ${l}\n                        `,e.push(c)}l.innerHTML="",e.forEach(e=>l.appendChild(e))}catch(e){l.innerHTML='<div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: var(--fp-color-error);">Errore caricamento calendario</div>'}}};p=d(),p&&p.size>0&&p.forEach((e,t)=>{const n=e.map(e=>{var t,n;return!e.label&&e.start_iso&&e.end_iso&&(e.label=(t=e.start_iso,n=e.end_iso,window.FPFront.availability?window.FPFront.availability.formatTimeRange(t,n):"Slot")),e});p.set(t,n)});const f=document.querySelector(".fp-exp-calendar-nav");if(f){f.addEventListener("click",e=>{const t=e.target.closest(".fp-exp-calendar-nav__day");if(!t||t.disabled)return;const a=t.getAttribute("data-date");a&&(f.querySelectorAll(".fp-exp-calendar-nav__day.is-selected").forEach(e=>{e.classList.remove("is-selected")}),t.classList.add("is-selected"),n&&(n.value=a,n.dispatchEvent(new Event("change",{bubbles:!0}))))}),f.addEventListener("click",e=>{const t=e.target.closest("[data-action]");if(!t)return;const n=t.getAttribute("data-action"),a=f.querySelector(".fp-exp-calendar-nav__content"),r=f.querySelector(".fp-exp-calendar-nav__month"),o=f.querySelector(".fp-exp-calendar-nav__year");if(!a||!r||!o)return;const i=a.getAttribute("data-current-month")||"2025-01",s=new Date(i+"-01");let c;switch(n){case"prev-month":c=new Date(s.getFullYear(),s.getMonth()-1,1);break;case"next-month":c=new Date(s.getFullYear(),s.getMonth()+1,1);break;default:return}u(f,c)});const e=new Date;u(f,e)}function m(){const e=document.querySelector(".fp-exp-summary__cta");if(!e)return;const n=()=>{const t=r(),n=t&&Object.keys(t).length>0,o=!(!a||!a.querySelector(".fp-exp-slots__item.is-selected"));e.disabled=!(n&&o),e.textContent=n?o?"Procedi al pagamento":"Seleziona data e orario":"Seleziona almeno 1 biglietto"};function r(){const e={};return document.querySelectorAll(".fp-exp-party-table tbody tr[data-ticket]").forEach(t=>{const n=t.getAttribute("data-ticket")||"",a=t.querySelector(".fp-exp-quantity__input");if(!n||!a)return;const r=parseInt(a.value,10)||0;r>0&&(e[n]=r)}),e}function o(){const e={};return document.querySelectorAll(".fp-exp-addons li[data-addon]").forEach(t=>{const n=t.getAttribute("data-addon")||"",a=t.querySelector('input[type="checkbox"]');n&&a&&a.checked&&(e[n]=1)}),e}function i(){const e=document.querySelector("[data-fp-sticky-bar]");if(!e)return;const t=e.querySelector(".fp-exp-page__sticky-price-value");if(!t)return;const n=r(),a=o(),i=c&&c.currency||"EUR";let s=0;Object.entries(n).forEach(([e,t])=>{const n=document.querySelector(`tr[data-ticket="${e}"] .fp-exp-ticket__price[data-price]`),a=n?parseFloat(n.getAttribute("data-price")||"0"):0;s+=a*t}),Object.entries(a).forEach(([e,t])=>{const n=document.querySelector(`li[data-addon="${e}"] .fp-exp-addon__price[data-price]`),a=n?parseFloat(n.getAttribute("data-price")||"0"):0;s+=a*t});try{const e=new Intl.NumberFormat(void 0,{style:"currency",currency:i});t.textContent=e.format(s)}catch(e){t.textContent=String(s)}}(()=>{const e=document.querySelector(".fp-exp-summary");if(!e)return;const n=e.querySelector("[data-fp-summary-status]"),s=e.querySelector("[data-fp-summary-body]"),l=e.querySelector("[data-fp-summary-lines]"),d=(e.querySelector("[data-fp-summary-adjustments]"),e.querySelector("[data-fp-summary-total-row]")),p=e.querySelector("[data-fp-summary-total]"),u=(e.getAttribute("data-loading-label"),e.getAttribute("data-error-label"),e.getAttribute("data-empty-label")||"Seleziona i biglietti per vedere il riepilogo"),f=(e,t)=>{try{return new Intl.NumberFormat(void 0,{style:"currency",currency:t||"EUR"}).format(Number(e||0))}catch(t){return String(e||0)}},m=e=>{if(n){n.hidden=!1;const t=n.querySelector(".fp-exp-summary__message");t&&(t.textContent=e||u)}s&&(s.hidden=!0)},y=()=>{const e=r(),t=o(),i=a&&a.querySelector(".fp-exp-slots__item.is-selected");if(!e||0===Object.keys(e).length)return void m(u);if(!i)return void m("Seleziona data e orario per vedere il prezzo");let y=0;const g=c&&c.currency||"EUR";Object.entries(e).forEach(([e,t])=>{const n=document.querySelector(`tr[data-ticket="${e}"] .fp-exp-ticket__price[data-price]`),a=n?parseFloat(n.getAttribute("data-price")||"0"):0;y+=a*t}),Object.entries(t).forEach(([e,t])=>{const n=document.querySelector(`li[data-addon="${e}"] .fp-exp-addon__price[data-price]`),a=n?parseFloat(n.getAttribute("data-price")||"0"):0;y+=a*t}),l&&(l.innerHTML="",Object.entries(e).forEach(([e,t])=>{if(t>0){const n=document.querySelector(`tr[data-ticket="${e}"] .fp-exp-ticket__price[data-price]`),a=n?parseFloat(n.getAttribute("data-price")||"0"):0,r=document.querySelector(`tr[data-ticket="${e}"] .fp-exp-ticket__label`),o=r?r.textContent.trim():`Biglietto ${e}`,i=document.createElement("li");i.className="fp-exp-summary__line";const s=document.createElement("span");s.className="fp-exp-summary__line-label",s.textContent=`${o} × ${t}`;const c=document.createElement("span");c.className="fp-exp-summary__line-amount",c.textContent=f(a*t,g),i.appendChild(s),i.appendChild(c),l.appendChild(i)}}),Object.entries(t).forEach(([e,t])=>{if(t>0){const n=document.querySelector(`li[data-addon="${e}"] .fp-exp-addon__price[data-price]`),a=n?parseFloat(n.getAttribute("data-price")||"0"):0,r=document.querySelector(`li[data-addon="${e}"] .fp-exp-addon__label`),o=r?r.textContent.trim():`Extra ${e}`,i=document.createElement("li");i.className="fp-exp-summary__line";const s=document.createElement("span");s.className="fp-exp-summary__line-label",s.textContent=`${o} × ${t}`;const c=document.createElement("span");c.className="fp-exp-summary__line-amount",c.textContent=f(a*t,g),i.appendChild(s),i.appendChild(c),l.appendChild(i)}})),p&&(p.textContent=f(y,g)),d&&(d.hidden=!1),n&&(n.hidden=!0),s&&(s.hidden=!1)};t.addEventListener("change",e=>{e.target&&e.target.closest(".fp-exp-quantity__input")&&(y(),i()),e.target&&e.target.matches('.fp-exp-addons input[type="checkbox"]')&&(y(),i())}),t.addEventListener("input",e=>{e.target&&e.target.closest(".fp-exp-quantity__input")&&(y(),i())}),a&&a.addEventListener("click",e=>{e.target&&e.target.closest(".fp-exp-slots__item")&&(y(),i())}),y(),i()})(),e.addEventListener("click",async()=>{if(e.disabled)return;const t=r(),i=a&&a.querySelector(".fp-exp-slots__item.is-selected");if(!i||!t||0===Object.keys(t).length)return;const s=i.getAttribute("data-start")||"",l=i.getAttribute("data-end")||"",d=c&&c.experienceId||0;if(s&&l&&d)if("undefined"!=typeof fpExpConfig)if(fpExpConfig.restNonce)if(fpExpConfig.checkoutNonce)try{e.disabled=!0,e.textContent="Aggiunta al carrello...";const n=new URL("/wp-json/fp-exp/v1/cart/set",window.location.origin),a=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":"undefined"!=typeof fpExpConfig&&fpExpConfig.restNonce||""},credentials:"same-origin",body:JSON.stringify({experience_id:d,slot_id:0,slot_start:s,slot_end:l,tickets:t,addons:o()})});if(!a.ok){let e={};try{const t=await a.text();e=t?JSON.parse(t):{}}catch(e){}throw new Error(e.message||`Errore aggiunta al carrello (${a.status})`)}e.textContent="Creazione ordine...";const r=new URL("/wp-json/fp-exp/v1/checkout",window.location.origin),i=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify({nonce:"undefined"!=typeof fpExpConfig&&fpExpConfig.checkoutNonce||"",contact:{first_name:"Cliente",last_name:"Temporaneo",email:"temp@example.com",phone:""},billing:{first_name:"Cliente",last_name:"Temporaneo",email:"temp@example.com",phone:""},consent:{privacy:!0,marketing:!1}})});if(!i.ok){let e={};try{const t=await i.text();e=t?JSON.parse(t):{}}catch(e){}throw new Error(e.message||`Errore creazione ordine (${i.status})`)}let c={};try{const e=await i.text();if(!e||""===e.trim())throw new Error("Risposta vuota dal server");c=JSON.parse(e)}catch(e){throw new Error("Risposta non valida dal server")}const p=c.payment_url||c.data&&c.data.payment_url;if(!p)throw new Error("URL di pagamento non ricevuto");window.location.href=p}catch(t){e.disabled=!1;const a=t.message||"";a.includes("sessione")||a.includes("scaduta")||a.includes("session")?(e.textContent="Sessione scaduta - Ricarica",alert("La tua sessione è scaduta. Aggiorna la pagina (F5) e riprova.")):e.textContent="Errore - Riprova",setTimeout(()=>{e.textContent="Procedi al pagamento",n()},3e3)}else alert("Sessione non valida. Aggiorna la pagina e riprova.");else alert("Sessione non valida. Aggiorna la pagina e riprova.");else alert("Errore di configurazione. Aggiorna la pagina e riprova.")}),t.addEventListener("change",n),t.addEventListener("input",n),a&&a.addEventListener("click",n),n()}document.addEventListener("click",function(e){var t=e.target&&e.target.closest("[data-fp-scroll]");if(t){try{e.preventDefault(),e.stopPropagation()}catch(e){}var a=t.getAttribute("data-fp-scroll")||"";if(a){var r=null;if("calendar"===a||"dates"===a?r=f||document.querySelector('[data-fp-scroll-target="dates"], .fp-exp-calendar-nav'):"gallery"===a&&(r=document.querySelector('[data-fp-scroll-target="gallery"], .fp-exp-gallery')),("calendar"===a||"dates"===a)&&n)try{n.focus()}catch(e){}r&&"function"==typeof r.scrollIntoView&&r.scrollIntoView({behavior:"smooth",block:"start"})}}}),function(){if(!a)return;const e=c&&c.rtb&&!0===c.rtb.enabled,t=e?document.querySelector("form.fp-exp-rtb-form"):null,n=t?t.querySelector('input[name="start"]'):null,r=t?t.querySelector('input[name="end"]'):null;document.querySelector(".fp-exp-summary__cta");a.addEventListener("click",t=>{const o=t.target&&t.target.closest(".fp-exp-slots__item");if(!o)return;const i=o.getAttribute("data-start")||"",s=o.getAttribute("data-end")||"";window.FPFront.slots&&(window.FPFront.slots.init({slotsEl:a}),window.FPFront.slots.clearSelection()),o.classList.add("is-selected"),e&&n&&(n.value=i),e&&r&&(r.value=s);const c=document.querySelector(".fp-exp-summary__cta");c&&(c.disabled=!1)}),window.FPFront.slots&&window.FPFront.slots.init({slotsEl:a})}(),window.FPFront.quantity&&window.FPFront.quantity.init&&window.FPFront.quantity.init({widget:t}),function(){const e=document.querySelector(".fp-exp-summary");if(!e)return;const n=c&&c.rtb&&!0===c.rtb.enabled;if(!n)return window.FPFront.summaryWoo&&window.FPFront.summaryWoo.init&&window.FPFront.summaryWoo.init({widget:t,slotsEl:a,config:c}),void m();const r=document.querySelector("form.fp-exp-rtb-form"),o=r?r.querySelector('input[name="start"]'):null,i=r?r.querySelector('input[name="end"]'):null,s=r?r.querySelector('input[name="tickets"]'):null,l=r?r.querySelector('input[name="addons"]'):null,d=document.querySelector(".fp-exp-summary__cta");let p=null;d&&!p&&(p=document.createElement("p"),p.className="fp-exp-summary__cta-hint",p.setAttribute("aria-live","polite"),p.style.marginTop="6px",p.style.fontSize="0.92em",p.style.color="var(--fp-exp-text-muted, #666)",p.hidden=!0,d.parentNode&&d.parentNode.insertBefore(p,d.nextSibling));const u=e.querySelector("[data-fp-summary-status]"),f=e.querySelector("[data-fp-summary-body]"),y=e.querySelector("[data-fp-summary-lines]"),g=e.querySelector("[data-fp-summary-adjustments]"),b=e.querySelector("[data-fp-summary-total-row]"),h=e.querySelector("[data-fp-summary-total]"),x=e.querySelector(".fp-exp-summary__disclaimer"),_=e.getAttribute("data-loading-label")||"Aggiornamento prezzo…",w=e.getAttribute("data-error-label")||"Impossibile aggiornare il prezzo. Riprova.",v=e.getAttribute("data-empty-label")||"Seleziona i biglietti per vedere il riepilogo",S=(e,t)=>{try{return new Intl.NumberFormat(void 0,{style:"currency",currency:t||"EUR"}).format(Number(e||0))}catch(t){return String(e||0)}},E=e=>{if(u){u.hidden=!1;const t=u.querySelector(".fp-exp-summary__message");t&&(t.textContent=e||v)}f&&(f.hidden=!0)},F=()=>{const e={};return document.querySelectorAll(".fp-exp-party-table tbody tr[data-ticket]").forEach(t=>{const n=t.getAttribute("data-ticket")||"",a=t.querySelector(".fp-exp-quantity__input");if(!n||!a)return;const r=parseInt(a.value,10)||0;r>0&&(e[n]=r)}),e},q=()=>{const e={};return document.querySelectorAll(".fp-exp-addons li[data-addon]").forEach(t=>{const n=t.getAttribute("data-addon")||"",a=t.querySelector('input[type="checkbox"]');n&&a&&a.checked&&(e[n]=1)}),e},C=()=>{const e=document.querySelector("[data-fp-sticky-bar]");if(!e)return;const t=e.querySelector(".fp-exp-page__sticky-price-value");if(!t)return;const n=F(),a=q(),r=c&&c.currency||"EUR";let o=0;Object.entries(n).forEach(([e,t])=>{const n=document.querySelector(`tr[data-ticket="${e}"] .fp-exp-ticket__price[data-price]`),a=n?parseFloat(n.getAttribute("data-price")||"0"):0;o+=a*t}),Object.entries(a).forEach(([e,t])=>{const n=document.querySelector(`li[data-addon="${e}"] .fp-exp-addon__price[data-price]`),a=n?parseFloat(n.getAttribute("data-price")||"0"):0;o+=a*t});try{const e=new Intl.NumberFormat(void 0,{style:"currency",currency:r});t.textContent=e.format(o)}catch(e){t.textContent=String(o)}},k=c&&c.experienceId||0,A=(()=>{const e=window.fpExpApiBase&&"string"==typeof window.fpExpApiBase?window.fpExpApiBase:window.wpApiSettings&&wpApiSettings.root||location.origin+"/wp-json/";return(e.endsWith("/")?e:e+"/")+"fp-exp/v1/rtb/quote"})();let P=null;const N=()=>{if(!d)return;const e=F(),t=e&&Object.keys(e).length>0,n=o&&i?Boolean((o.value||"").trim()&&(i.value||"").trim()):!(!a||!a.querySelector(".fp-exp-slots__item.is-selected"));d.disabled=!(t&&n),p&&(t?n?(p.textContent="",p.hidden=!0):(p.textContent="Seleziona data e orario.",p.hidden=!1):(p.textContent="Seleziona almeno 1 biglietto.",p.hidden=!1))},L=()=>{if(!k)return E(v),void N();const t=F(),n=q();if(s&&(s.value=JSON.stringify(t)),l&&(l.value=JSON.stringify(n)),!t||0===Object.keys(t).length)return E(v),void N();E(_);const a={nonce:c&&c.rtbNonce||c&&c.nonce||(r?r.getAttribute("data-nonce"):""),experience_id:k,slot_id:0,start:o?o.value:"",end:i?i.value:"",tickets:t,addons:n},d={"Content-Type":"application/json"};"undefined"!=typeof fpExpConfig&&fpExpConfig.restNonce&&(d["X-WP-Nonce"]=fpExpConfig.restNonce),fetch(A,{method:"POST",credentials:"same-origin",headers:d,body:JSON.stringify(a)}).then(e=>{if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);return e.json()}).then(t=>{if(!t||!0!==t.success||!t.breakdown)return void E(w);const n=t.breakdown;if(y){y.innerHTML="";const e=e=>{const t=document.createElement("li");t.className="fp-exp-summary__line";const a=document.createElement("span");a.className="fp-exp-summary__line-label",a.textContent=`${e.label} × ${e.quantity}`;const r=document.createElement("span");return r.className="fp-exp-summary__line-amount",r.textContent=S(e.line_total,n.currency),t.appendChild(a),t.appendChild(r),t};(Array.isArray(n.tickets)?n.tickets:[]).forEach(t=>y.appendChild(e(t))),(Array.isArray(n.addons)?n.addons:[]).forEach(t=>y.appendChild(e(t)))}if(g){const e=Array.isArray(n.adjustments)?n.adjustments:[];0===e.length?(g.hidden=!0,g.innerHTML=""):(g.hidden=!1,g.innerHTML="",e.forEach(e=>{const t=document.createElement("li");t.className="fp-exp-summary__adjustment";const a=document.createElement("span");a.className="fp-exp-summary__adjustment-label",a.textContent=e.label||"";const r=document.createElement("span");r.className="fp-exp-summary__adjustment-amount",r.textContent=S(e.amount,n.currency),t.appendChild(a),t.appendChild(r),g.appendChild(t)}))}if(h&&(h.textContent=S(n.total,n.currency)),b&&(b.hidden=!1),x){const t=e.getAttribute("data-tax-label")||"";t&&(x.textContent=t,x.hidden=!1)}u&&(u.hidden=!0),f&&(f.hidden=!1),N()}).catch(e=>{E(w),N()})},T=()=>{P&&clearTimeout(P),P=setTimeout(L,300)};t.addEventListener("change",e=>{e.target&&e.target.closest(".fp-exp-quantity__input")&&(T(),N(),C()),e.target&&e.target.matches('.fp-exp-addons input[type="checkbox"]')&&(T(),C())}),t.addEventListener("input",e=>{e.target&&e.target.closest(".fp-exp-quantity__input")&&(T(),N(),C())}),a&&n&&a.addEventListener("click",e=>{e.target&&e.target.closest(".fp-exp-slots__item")&&(T(),N(),C())}),N(),C(),window.FPFront.summaryRtb&&window.FPFront.summaryRtb.init&&window.FPFront.summaryRtb.init({widget:t,slotsEl:a,config:c})}(),function(){const e=document.querySelector("[data-fp-gift-toggle]"),t=document.querySelector("[data-fp-gift]"),n=t?t.querySelector("[data-fp-gift-backdrop]"):null,a=t?t.querySelector("[data-fp-gift-close]"):null,r=t?t.querySelector("[data-fp-gift-dialog]"):null,o=t?t.querySelector("[data-fp-gift-form]"):null,i=o?o.querySelector("[data-fp-gift-submit]"):null,s=t?t.querySelector("[data-fp-gift-feedback]"):null;if(!e||!t)return;let c={};try{const e=t.getAttribute("data-fp-gift-config");c=e?JSON.parse(e):{}}catch(e){}const l=()=>{t.classList.remove("is-open"),setTimeout(()=>{t.hidden=!0,t.setAttribute("aria-hidden","true"),e.setAttribute("aria-expanded","false"),document.body.style.overflow="",e.focus()},250)};e.addEventListener("click",n=>{n.preventDefault(),t.hidden=!1,t.setAttribute("aria-hidden","false"),e.setAttribute("aria-expanded","true"),setTimeout(()=>{t.classList.add("is-open")},10),r&&setTimeout(()=>{r.focus()},100),document.body.style.overflow="hidden"}),a&&a.addEventListener("click",e=>{e.preventDefault(),l()}),n&&n.addEventListener("click",e=>{e.preventDefault(),l()}),document.addEventListener("keydown",e=>{"Escape"!==e.key||t.hidden||l()}),o&&i&&o.addEventListener("submit",async e=>{if(e.preventDefault(),!o.checkValidity())return void o.reportValidity();const t=new FormData(o),n={experience_id:c.experienceId||0,purchaser:{name:t.get("purchaser[name]")||"",email:t.get("purchaser[email]")||""},recipient:{name:t.get("recipient[name]")||"",email:t.get("recipient[email]")||""},delivery:{send_on:t.get("delivery[send_on]")||""},quantity:parseInt(t.get("quantity"),10)||1,message:t.get("message")||"",addons:t.getAll("addons[]")||[]};i.disabled=!0,i.textContent="Elaborazione...";try{const e=await fetch("/wp-json/fp-exp/v1/gift/create",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":"undefined"!=typeof fpExpConfig&&fpExpConfig.restNonce||""},credentials:"same-origin",body:JSON.stringify(n)});if(!e.ok){let t={};try{t=await e.json()}catch(e){}throw new Error(t.message||"Errore durante la creazione del voucher regalo")}const t=await e.json(),a=t.payment_url||t.checkout_url||t.data&&t.data.payment_url;a?window.location.href=a:(s&&(s.hidden=!1,s.className="fp-gift__feedback fp-gift__feedback--success",s.textContent="Voucher regalo creato con successo!"),o.reset(),setTimeout(()=>{l(),s&&(s.hidden=!0,s.textContent="")},2e3))}catch(e){s&&(s.hidden=!1,s.className="fp-gift__feedback fp-gift__feedback--error",s.textContent=e.message||"Si è verificato un errore. Riprova.")}finally{i.disabled=!1,i.textContent="Procedi al pagamento"}})}()})}();