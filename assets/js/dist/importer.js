!function(e){"use strict";const t={init:function(){this.fileInput=e("#csv_file"),this.submitBtn=e('button[name="fp_exp_import_experiences"]'),this.previewContainer=e("#fp-exp-csv-preview"),this.fileInput.length&&this.bindEvents()},bindEvents:function(){this.fileInput.on("change",this.handleFileSelect.bind(this))},handleFileSelect:function(e){const t=e.target.files[0];if(t)return this.isValidFileType(t)?t.size>5242880?(this.showError("File troppo grande. Dimensione massima: 5MB."),void this.submitBtn.prop("disabled",!0)):void this.readAndPreview(t):(this.showError("Formato file non valido. Per favore seleziona un file CSV."),void this.submitBtn.prop("disabled",!0));this.clearPreview()},isValidFileType:function(e){return["text/csv","application/vnd.ms-excel","text/plain"].includes(e.type)||[".csv"].some(t=>e.name.toLowerCase().endsWith(t))},readAndPreview:function(e){const t=new FileReader;t.onload=t=>{try{const i=this.parseCSV(t.target.result);this.showPreview(i,e),this.submitBtn.prop("disabled",!1)}catch(e){this.showError("Errore nella lettura del file CSV: "+e.message),this.submitBtn.prop("disabled",!0)}},t.onerror=()=>{this.showError("Errore nella lettura del file."),this.submitBtn.prop("disabled",!0)},t.readAsText(e)},parseCSV:function(e){const t=e.split("\n").filter(e=>e.trim());if(t.length<2)throw new Error("Il file deve contenere almeno una riga di intestazione e una di dati.");const i=this.parseCSVLine(t[0]),n=[];for(let e=1;e<Math.min(t.length,6);e++){const r=this.parseCSVLine(t[e]),s={};i.forEach((e,t)=>{s[e]=r[t]||""}),n.push(s)}return{headers:i,rows:n,totalRows:t.length-1}},parseCSVLine:function(e){const t=[];let i="",n=!1;for(let r=0;r<e.length;r++){const s=e[r];'"'===s?n&&'"'===e[r+1]?(i+='"',r++):n=!n:","!==s||n?i+=s:(t.push(i.trim()),i="")}return t.push(i.trim()),t},showPreview:function(t,i){this.previewContainer.length||(this.previewContainer=e('<div id="fp-exp-csv-preview"></div>'),this.fileInput.closest("td").append(this.previewContainer));let n='<div class="fp-exp-csv-preview-box" style="margin-top: 16px; padding: 16px; background: #f0f6fc; border: 1px solid #c8e1ff; border-radius: 8px;">';n+='<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">',n+='<span style="font-size: 24px;">üìä</span>',n+="<div>",n+='<strong style="display: block; font-size: 14px;">'+this.escapeHtml(i.name)+"</strong>",n+='<span style="font-size: 12px; color: #57606a;">',n+=t.totalRows+" "+(1===t.totalRows?"esperienza":"esperienze"),n+=" ‚Ä¢ "+this.formatFileSize(i.size),n+="</span>",n+="</div>",n+="</div>";t.headers.some(e=>"title"===e.toLowerCase())||(n+='<div style="padding: 8px 12px; background: #fff3cd; border-left: 4px solid #ffc107; margin-bottom: 12px; border-radius: 4px;">',n+='<strong>‚ö†Ô∏è Attenzione:</strong> La colonna "title" sembra mancare. √à obbligatoria per l\'import.',n+="</div>"),n+='<div style="max-height: 300px; overflow: auto; background: white; border-radius: 6px; padding: 8px;">',n+='<table style="width: 100%; border-collapse: collapse; font-size: 12px;">',n+="<thead><tr>",t.headers.forEach(e=>{const t="title"===e.toLowerCase();n+='<th style="text-align: left; padding: 8px; border-bottom: 2px solid #d0d7de; white-space: nowrap; '+(t?"font-weight: 700; color: #8b1e3f;":"")+'">',n+=this.escapeHtml(e),t&&(n+=" *"),n+="</th>"}),n+="</tr></thead>",n+="<tbody>",t.rows.forEach((e,i)=>{n+="<tr"+(i%2==0?' style="background: #f6f8fa;"':"")+">",t.headers.forEach(t=>{const i=e[t]||"",r=i.length>50?i.substring(0,47)+"...":i;n+='<td style="padding: 6px 8px; border-bottom: 1px solid #d0d7de;">',n+=this.escapeHtml(r),n+="</td>"}),n+="</tr>"}),n+="</tbody>",n+="</table>",n+="</div>",t.totalRows>5&&(n+='<p style="margin: 8px 0 0; font-size: 12px; color: #57606a;">',n+="... e altre "+(t.totalRows-5)+" "+(t.totalRows-5==1?"esperienza":"esperienze"),n+="</p>"),n+="</div>",this.previewContainer.html(n)},showError:function(t){this.previewContainer.length||(this.previewContainer=e('<div id="fp-exp-csv-preview"></div>'),this.fileInput.closest("td").append(this.previewContainer));const i='<div class="notice notice-error" style="margin-top: 16px; padding: 12px;"><p style="margin: 0;"><strong>‚ùå Errore:</strong> '+this.escapeHtml(t)+"</p></div>";this.previewContainer.html(i)},clearPreview:function(){this.previewContainer.length&&this.previewContainer.empty(),this.submitBtn.prop("disabled",!1)},formatFileSize:function(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,t)*100)/100+" "+["Bytes","KB","MB"][t]},escapeHtml:function(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}};e(document).ready(function(){t.init()})}(jQuery);