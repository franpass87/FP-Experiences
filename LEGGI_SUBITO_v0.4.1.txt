═══════════════════════════════════════════════════════════════
🎯 REFACTOR MINIMALE FAILSAFE v0.4.1 - COMPLETATO!
═══════════════════════════════════════════════════════════════

✅ HO FATTO IL REFACTOR!

Sistema ora è:
✓ Auto-riparante (capacity=0 → repair automatico)
✓ Loggato completamente (anche con WP_DEBUG=false)
✓ Dettagliato (errori con tutti i dati)

═══════════════════════════════════════════════════════════════
📤 STEP 1: CARICA 6 FILE VIA FTP
═══════════════════════════════════════════════════════════════

Carica in: wp-content/plugins/FP-Experiences/

1. fp-experiences.php
2. src/Booking/Slots.php
3. src/Booking/Checkout.php
4. src/Booking/RequestToBook.php
5. src/Api/RestRoutes.php
6. src/Admin/DiagnosticShortcode.php

═══════════════════════════════════════════════════════════════
🧹 STEP 2: PULISCI CACHE
═══════════════════════════════════════════════════════════════

1. Dashboard → FP Experiences → Tools → "Pulisci Cache"
2. Dashboard → FP Performance → Svuota cache
3. Se hai OpCache, svuotala
4. Svuota cache browser (Ctrl+Shift+Del)

═══════════════════════════════════════════════════════════════
🧪 STEP 3: TESTA CHECKOUT
═══════════════════════════════════════════════════════════════

1. Apri esperienza (es. Degustazione Standard)
2. Seleziona data + orario
3. Aggiungi al carrello
4. Vai al checkout
5. Compila dati
6. Clicca "Effettua ordine"

═══════════════════════════════════════════════════════════════
✅ SE FUNZIONA
═══════════════════════════════════════════════════════════════

PERFETTO! Problema risolto definitivamente.

Il sistema ora:
- Auto-ripara capacity=0
- Logga tutto per prevenire problemi futuri
- Dettagli completi in caso di errore

═══════════════════════════════════════════════════════════════
❌ SE FALLISCE ANCORA
═══════════════════════════════════════════════════════════════

Via FTP, apri:
/wp-content/debug.log

Cerca le righe con:
[FP-EXP-CHECKOUT]
[FP-EXP-SLOTS]

COPIA le ultime 50 righe e mandamele.

Esempio log che vedrai:
[31-Oct-2025 22:00:00] [FP-EXP-CHECKOUT] Cart item: {"experience_id":9104,...}
[31-Oct-2025 22:00:00] [FP-EXP-SLOTS] ensure_slot called: exp=9104, start=2025-11-07 11:00:00
[31-Oct-2025 22:00:00] [FP-EXP-SLOTS] Availability meta: capacity=0, buffer_before=15
[31-Oct-2025 22:00:00] [FP-EXP-SLOTS] FAILSAFE: using default capacity=10
[31-Oct-2025 22:00:00] [FP-EXP-SLOTS] AUTO-REPAIR: updated experience meta
[31-Oct-2025 22:00:00] [FP-EXP-SLOTS] SUCCESS: created slot ID=123

I log ti diranno ESATTAMENTE cosa è successo!

═══════════════════════════════════════════════════════════════
🔧 ENDPOINT DIAGNOSTICO (opzionale)
═══════════════════════════════════════════════════════════════

Se vuoi vedere stato PRIMA del checkout:

Console Browser (nella pagina Tools):
fetch('/wp-json/fp-exp/v1/diagnostic/checkout', {
  headers: {'X-WP-Nonce': 'a6bb83c84c'}
})
.then(r => r.json())
.then(d => console.log(JSON.stringify(d, null, 2)));

Questo mostra:
- Cosa c'è nel carrello
- Meta di tutte le esperienze
- Testa creazione slot

═══════════════════════════════════════════════════════════════
💡 DIFFERENZA CON v0.4.0
═══════════════════════════════════════════════════════════════

v0.4.0:
❌ Log solo con WP_DEBUG=true
❌ capacity=0 → checkout fallisce
❌ Errore generico senza dettagli

v0.4.1:
✅ Log SEMPRE attivi
✅ capacity=0 → auto-repair + checkout procede
✅ Errori dettagliati con tutti i dati

═══════════════════════════════════════════════════════════════
🚀 PRONTO!
═══════════════════════════════════════════════════════════════

1. Carica i 6 file
2. Pulisci cache
3. Testa checkout
4. Se fallisce: mandami debug.log (ultime 50 righe con [FP-EXP-])

DEPLOY SICURO - RISCHIO BASSO - IMPATTO ALTO

═══════════════════════════════════════════════════════════════

